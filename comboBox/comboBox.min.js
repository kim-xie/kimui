(function($){
	var loadingCss = {
		css: function(path){
			var path = loadingCss.getParentPath() + path;
			if(!path || path.length === 0){
				throw new Error('argument "path" is required !');
			}
			var head = document.getElementsByTagName('head')[0];
			var link = document.createElement('link');
			link.href = path;
			link.rel = 'stylesheet';
			link.type = 'text/css';
			head.appendChild(link);
		},
		getParentPath:function(){
			var ParentPath = document.scripts;
			ParentPath = ParentPath[ParentPath.length-1].src.substring(0,ParentPath[ParentPath.length-1].src.lastIndexOf("/")+1);
			return ParentPath;
		}
	}
	loadingCss.css("skin/comboBox.min.css");

	//定义jquery对象
	$.fn.kimComboBox = function(options) {
		return this.each(function() {
			var opts = $.extend({}, $.fn.kimComboBox.defaults, options);
			init($(this), opts);
			initEvent($(this),opts);
		});
	};
	
	//初始化方法
	function init($this,opts){

		var kimComboBox = "<div id='kimComboBoxWrap' class='kimComboBoxWrap'>";
		
		if(opts.removeIdsObj && opts.validateId && opts.validateIdType){
			kimComboBox +=	"<input id='"+opts.removeIdsObj+"' name='"+opts.inputName+"' type='hidden' class='vilidateObj removeIds' vilidate='"+opts.validateIdType+"'/>";
		}else if(opts.removeIdsObj){
			kimComboBox +=	"<input id='"+opts.removeIdsObj+"' name='"+opts.inputName+"' type='hidden' class='removeIds'/>";
		}
		if(opts.addIdsObj && opts.validateId && opts.validateIdType){
			kimComboBox +=	"<input id='"+opts.addIdsObj+"' name='"+opts.inputName+"' type='hidden' class='vilidateObj addIds' vilidate='"+opts.validateIdType+"'/>";
		}else if(opts.addIdsObj){
			kimComboBox +=	"<input id='"+opts.addIdsObj+"' name='"+opts.inputName+"' type='hidden' class='addIds'/>";
		}
		if(opts.idObj && opts.validateId && opts.validateIdType){
			kimComboBox +=	"<input id='"+opts.idObj+"' name='"+opts.inputName+"' value='"+opts.idValue+"' type='hidden' class='vilidateObj ids' vilidate='"+opts.validateIdType+"'/>";
		}else if(opts.idObj){
			kimComboBox +=	"<input id='"+opts.idObj+"' name='"+opts.inputName+"' value='"+opts.idValue+"' type='hidden' class='ids'/>";
		}
		
		kimComboBox += "<div class='kimComboBox borderCd'>";
			
		if(opts.textId && opts.validateVal && opts.validateValType){
			kimComboBox += "<span id='"+opts.textId+"' class='vilidateObj contents ellipsis' vilidate='"+opts.validateValType+"'>"+opts.textValue+"</span>";
		}else{
			kimComboBox += "<span id='"+opts.textId+"' class='contents ellipsis'>"+opts.textValue+"</span>";
		}

		kimComboBox +=  "	<span class='icon'>"+
						"		<i class='fa fa-sort-down pointer'></i>"+
						"	</span>"+
						"</div>";


		if(opts.listId || opts.listClass){
			kimComboBox += "<div id='"+opts.listId+"' class='"+opts.listClass+" none' style='position:absolute;z-index:1000;'>";
		} 
		if(opts.listType && opts.listType == "list" && opts.showSearch ){
			kimComboBox += "<div class='searchBox'>	<span class='searchwrap'><input type='text' class='search_in' maxlength='30' placeholder='请输入搜索关键字...'/><i class='fa fa-times-circle fa-lg inputclear cd'></i></span></div>";
		}
		if(opts.listType && opts.listType == "list" && opts.listcontents ){
			kimComboBox += "<div id='listBox'><div id='listRoot'><ul>";
			var liDom = "";
			for(var i=0;i<opts.listcontents.length;i++){
				if(opts.isMultiSelect){
					liDom += "<li><a href='javascript:void(0)' class='ellipsis' data-id='"+opts.listids[i]+"' title='"+opts.listcontents[i]+"'>"+opts.listcontents[i]+"</a><i class='fa fa-check fa-lg'></i></li>";
				}else{
					liDom += "<li><a href='javascript:void(0)' class='ellipsis' data-id='"+opts.listids[i]+"' title='"+opts.listcontents[i]+"'>"+opts.listcontents[i]+"</a></li>";
				}
			}
			kimComboBox += liDom + "<li id='noData' style='display:none;text-align:center;font-size:14px;'>"+opts.noDataText+"</li></ul></div></div>";
		}

		kimComboBox += "</div></div>";

		$this.append(kimComboBox);
		/*if(opts.showSearch){
			$this.find("#listBox").css("margin-top","40px");
		}*/

		if(opts.textValue === "请选择"){
			$this.find(".contents").addClass("cplaceholder");
		}else{
			$this.find(".contents").removeClass("cplaceholder");
		}
		

		if(opts.width){
			$this.find(".kimComboBox").width($this.find("#kimComboBoxWrap").width() - 47);
			$this.find("#listBox li").css({"padding":"1px 35px 1px 6px","height":"28px","line-height":"28px"});
			$this.find("#listBox li a").width(opts.width).css({"display":"inline-block"});
			$this.find("#listBox li a input").css({"margin-bottom":"3px","vertical-align":"middle"});
		}
		if(opts.height){
			//$this.find(".kimComboBox").height(opts.height);
			$this.find(".kimComboBox .contents").css("line-height",opts.height+"px");
			$this.find(".kimComboBox .icon i").css("line-height",opts.height+"px");
		}
		
		if(opts.searchBoxWidth){
			$this.find(".searchBox").width(opts.searchBoxWidth - 2);
		}
		if(typeof opts.listWidth == "string" && opts.listWidth.indexOf("%") != -1){
			$this.find("."+opts.listClass+"").width($this.width() - 2);
		}else{
			$this.find("."+opts.listClass+"").width(opts.listWidth - 2);
			$this.find(".searchBox").width(parseInt(opts.listWidth) - 10);
		}
		if(opts.listHeight){
			$this.find("."+opts.listClass+"").height(opts.listHeight);
			if($this.find("#listBox").prev().hasClass("searchBox")){
				$this.find("#listBox").height(parseInt(opts.listHeight) - 38);
			}else{
				$this.find("#listBox").height(parseInt(opts.listHeight));
			}
		}
		if(opts.listBackground){
			$this.find("."+opts.listClass+"").css("background",opts.listBackground);
		}
		if(opts.listBorder){
			$this.find("."+opts.listClass+"").css({"border":opts.listBorder,"border-radius":"2px"});
		}
		$this.find("#noData").css({"padding":"0","height":$this.find("#listBox").height(),"line-height":$this.find("#listBox").height() + "px"});
		$this.find("#overlay .imgBox").css({"left":($this.find("#overlay").width() - 100)/2 +"px","top":($this.find("#listBox").height() - 110)/2+"px"});
	}

	//初始化事件
	function initEvent($this,opts){
		
		if(!opts.disable){
			//展开收起下拉列表
			$this.find(".kimComboBox").click(function(e){
				e = e || window.event || arguments.callee.caller.arguments[0]; //兼容firefox
				stopPropagation(e);
				$(this).children().first().css("user-select","none");
				var target = e.target || e.srcElement;
				// 重置
				if(target.nodeName.toLowerCase() === "i" && target.getAttribute("class").indexOf("selectClear") !== -1){
					$(this).parents("#kimComboBoxWrap").find(".contents").text("");
					$(this).parents("#kimComboBoxWrap").find("input").val("");
					$this.find("#listBox #listRoot ul li").removeClass("on");
					if(opts.listType == "tree"){
						$(this).parents("#kimComboBoxWrap").find(".trees .search_in").val("");
						$(this).parents("#kimComboBoxWrap").find(".trees .tm-tree-checkbox").removeClass("tm-tree-checkbox-checked").removeClass("tm-tree-checkbox-focus");
						$(this).parents("#kimComboBoxWrap").find(".trees .tm-tree-radio").removeClass("tm-tree-radio-checked").removeClass("tm-tree-radio-focus");
						$(this).parents("#kimComboBoxWrap").find(".trees .tree .toggle").removeClass("first_collapsable").addClass("expandable");
						$(this).parents("#kimComboBoxWrap").find(".trees .tree .father").next().hide();
					}else if(opts.listType == "list" && opts.isMultiSelect){
						checkedNameArr = [];
						checkedIdArr = [];
						$this.find("#listBox #listRoot ul li").find("a").removeClass("selected");
					}
				}else{
					$(this).parent().find("."+opts.listClass+"").toggle();
					//$(this).parent().find(".icon .fa").toggleClass("fa-sort-up fa-sort-down");
					//$(this).toggleClass("borderBlue borderCd")
					if($(this).parent().find(".icon .fa").hasClass("fa-sort-up")){
						$(this).parent().find(".icon .fa").removeClass("fa-sort-up").addClass("fa-sort-down");
						$(this).css("border-color","#97a8be");
					}else if($(this).parent().find(".icon .fa").hasClass("fa-sort-down")){
						$(this).parent().find(".icon .fa").removeClass("fa-sort-down").addClass("fa-sort-up");
						$(this).css("border-color","#20a0ff");
					}
				}
				
				if($(this).parents("td")){
					$(this).parents("td").siblings().find("."+opts.listClass+"").hide();
					$(this).parents("tr").siblings().find("."+opts.listClass+"").hide();
				}
				if($(this).parents("tr")){
					$(this).parents("tr").siblings().find(".kimComboBoxList").hide();
				}
				stopDefault(e);
			});

			if(opts.triggerClick){
				if(opts.showClearButton && $this.find(".kimComboBox").find(".icon .fa").hasClass("fa-sort-down")){
					$this.find(".contents").parent().find(".icon .fa").hover(function(){
						showClear(opts,$this);
					},function(){
						if(!$this.find(".kimComboBox").find(".icon .fa").hasClass("fa-sort-up")){
							$this.find(".contents").parent().find(".icon .fa").removeClass("fa-remove selectClear").addClass("fa-sort-down");
						}
					});
				}
			}
		}else{
			$this.find(".kimComboBox").css("background","#f3f3f3");
		}
		
		//下拉框为数控件时的初始化事件
		if(opts.listType && opts.listType == "tree" && opts.tree){
			$this.find("#"+opts.listId+"").kimTree(opts.tree);
		}

		//下拉框为list控件时的初始化事件
		if(opts.listType && opts.listType == "list"){
			$this.find("#kimComboBoxWrap ul li").hover(function(){
				$(this).addClass("liHover").css("background","#e4e8f1");
			},function(){
				$(this).removeClass("liHover").css("background","");
			});
		}
		
		//给list内容框赋值
		if(opts.listType == "list" && opts.listcontents){
			//阻止事件冒泡
			$this.click(function(e) {
                e = e || window.event || arguments.callee.caller.arguments[0];
                stopPropagation(e);
            });

			if (opts.showSearch) {
				//键盘抬起时进行搜索
				$this.find(".search_in").keyup(function() {
					var serachVal = $.trim($(this).val());
                    queryData(opts,$this,serachVal,opts.listcontents);
                });

				//输入框获取焦点事件
                $this.find(".search_in").focus(function() {
                    $this.find(".inputclear").show().removeClass("cd").removeClass("tm_red").addClass("cb");
                });
				//输入框失去焦点事件
                $this.find(".search_in").blur(function() {
                    var val = $this.find(".search_in").val();
                    if (val != null  || val != "") {
                        $this.find(".inputclear").show().removeClass("cb").removeClass("tm_red").addClass("cd");
                    } else {
                        $this.find(".inputclear").hide();
                    }
                });
				//重置按钮事件
                $this.find(".inputclear").click(function() {
                    $(this).parent().find(".search_in").val("");
					$(this).hide();
                    queryData(opts,$this,"",opts.listcontents);
                });
            }
			
			if(opts.triggerClick){
				//选择下拉框数据
				var checkedNameArr = [],checkedIdArr = [];
				$this.find("ul li a").bind("click",function(e){
					e = e || window.event || arguments.callee.caller.arguments[0];
					var target = e.target || e.srcElement;
					var aText = "",aId = "";
					//点击非checkbox
					if(target.nodeName.toLowerCase() === "a"){
						if(opts.isMultiSelect){
							aText = $(this).text();
							aId = $(this).attr("data-id");
							//多选a
							$(this).parent().toggleClass("selected");
							if($(this).parent().hasClass("selected")){
								checkedNameArr.push($(this).text());
								checkedIdArr.push($(this).attr("data-id"));
							}else{
								for(var i=0;i<checkedNameArr.length;i++){
									if(checkedNameArr[i] === aText){
										checkedNameArr.splice(i,1);
										checkedIdArr.splice(i,1);
									}
								}
							}
							$this.find(".contents").text(checkedNameArr.join(",")).attr("title",checkedNameArr.join(",")).css("color","#1f2d3d");
							$this.find("#"+opts.idObj).val(checkedIdArr);
							//点击下拉框数据时触发的方法
							if(opts.onchange){
								opts.onchange($(this),aId,aText);
							}
						}else{
							//单选a
							$(this).parent().addClass("on");
							$(this).parent().siblings().removeClass("on");
							aText = $(this).text();
							aId = $(this).attr("data-id");
							$this.find(".contents").text(aText).attr("title",aText).css("color","#1f2d3d");
							$this.find("#"+opts.idObj).val(aId);
							//点击下拉框数据时触发的方法
							if(opts.onchange){
								opts.onchange($this,aId,aText);
							}
						}
					}
					
					//不是多选的话点击下拉框里的数据就可以收起下拉框
					if(!opts.isMultiSelect){
						//触发下拉框事件
						$this.find(".kimComboBox").trigger("click");
					}
					
				});
				
			}else{
				$this.find("input:checkbox").attr("disabled",true);
			}
		}
		
		//初始化值时根据文本查询对应的ID
		if(opts.useFindIdByText){
			var initText = $this.find(".kimComboBoxWrap .contents").text();
			if(initText){
				var liDom = $this.find("#listBox #listRoot ul li");
				liDom.find("a[title='"+initText+"']").addClass("on");
				var initId = liDom.find("a[title='"+initText+"']").attr("data-id");
				$this.find(".kimComboBoxWrap input.ids").val(initId);
			}
		}
		
		//初始化值时根据ID查询对应的文本
		if(opts.useFindTextById){
			var initId = $this.find(".kimComboBoxWrap input.ids").val();
			var liDom = $this.find("#listBox #listRoot ul li");
			liDom.find("a[data-id='"+initId+"']").addClass("on");
			var initText = liDom.find("a[data-id='"+initId+"']").text();
			$this.find(".kimComboBoxWrap .contents").text(initText);
		}
		
		//初始化值时根据IDs查询对应的文本
		if(opts.useFindTextByIds){
			var initIds = $this.find(".kimComboBoxWrap input.ids").val().split(",");
			if(opts.listType && opts.listType == "tree" && opts.tree){
				var liDom = $this.find("#treeWrap #treeRoot ul li");
				var initText = [];
				for(var i=0;i<initIds.length;i++){
					initText.push(liDom.find("span[opid='"+initIds[i]+"']").attr("data-title"));
//					if(opts.isMultiSelect){
//						//liDom.find("a[data-id='"+initIds[i]+"'] input:checkbox").attr("checked",true);
//						liDom.find("a[data-id='"+initIds[i]+"'] input:checkbox").trigger("click");
//					}
					liDom.find("span[opid='"+initIds[i]+"']").trigger("click");
				}
				$this.find(".kimComboBoxWrap .contents").text(initText.join(","));
			}else{
				var liDom = $this.find("#listBox #listRoot ul li");
				var initText = [];
				for(var i=0;i<initIds.length;i++){
					initText.push(liDom.find("a[data-id='"+initIds[i]+"']").text());
					if(opts.isMultiSelect){
						//liDom.find("a[data-id='"+initIds[i]+"'] input:checkbox").attr("checked",true);
						liDom.find("a[data-id='"+initIds[i]+"'] input:checkbox").trigger("click");
					}
				}
				//$this.find(".kimComboBoxWrap .contents").text(initText.join(",")).attr("title",initText.join(","));
			}
		}
		
		//点击文档收起下拉框
		$(document).click(function(){
			$this.find("."+opts.listClass+"").hide();
			$this.find(".icon .fa").removeClass("fa-sort-up").addClass("fa-sort-down");
			$this.find(".kimComboBox").css("border-color","");
			if(!$this.find(".kimComboBoxWrap .contents").text()){
				$this.find(".kimComboBoxWrap .contents").text("请选择").css("color","#97a8be").addClass("cplaceholder");
			}
		});
		
	}

	//动态加载数据
	function queryData(opts,obj,arg,listcontents){
		var newArray = listcontents;
		listData = [];
		if(arg && isNotEmpty(newArray)){
			for(var i=0;i<newArray.length;i++){
				if(newArray[i].indexOf(arg) !== -1){
					listData.push(newArray[i]);
				}else{
					obj.find("#listRoot ul li").hide();
				}
			}
		}else{
			obj.find(".inputclear").hide();
			obj.find("#listRoot ul li").show();
			obj.find("#listRoot ul").find("#noData").hide();
			obj.find("#listRoot ul").find("li a").html(function () {  
				return $(this).html().replace('<b style="color:'+opts.searchedColor+';">', '').replace('</b>', ''); 
			}); 
		}
		if(listData.length === 0 && arg){
			obj.find("#listRoot ul").find("#noData").show();
			obj.find("#listRoot ul").find("li a").html(function () {  
				return $(this).html().replace('<b style="color:'+opts.searchedColor+';">', '').replace('</b>', ''); 
			}); 
			obj.find(".inputclear").show().removeClass("cb").removeClass("cd").addClass("tm_red");
		}else{
			var regText = new RegExp(arg.toLowerCase(),"gi"); // regText为//gi
			for(var i=0;i<listData.length;i++){
				obj.find(".inputclear").show().removeClass("tm_red").addClass("cb");
				obj.find("#listRoot ul").find("li a[title='"+listData[i]+"']").parent().show();
				obj.find("#listRoot ul").find("li a[title='"+listData[i]+"']").html(function () {  
					return $(this).html().replace('<b style="color:'+opts.searchedColor+';">', '').replace('</b>', '').replace(regText, '<b style="color:'+opts.searchedColor+';">'+arg.toLowerCase()+'</b>'); 
				});  
				obj.find("#listRoot ul").find("#noData").hide();
			}
		}
	}
	

	//默认参数
	$.fn.kimComboBox.defaults = {
		width:"100%",//展示框的宽度
		height:"30px",//展示框的高度
		validateId:false,//是否需要验证Id
		validateVal:false,//是否需要验证Val
		validateIdType:"required",//验证类型 (默认为非空验证-required)- email/phone/chinese/idcard
		validateValType:"required",//验证类型 (默认为非空验证-required)- email/phone/chinese/idcard
		addIdsObj:"",//存放增量ID的Dom对象
		removeIdsObj:"",//存放删除ID的Dom对象
		idObj:"",//存放ID的Dom对象
		inputName: "inputName",//输入框的name值
		idValue:"",//存放的ID值
		textId:"contents",//显示文本框的id
		textValue:"请选择",//展示框的显示值
		listId:"kimComboBoxList",//下拉框的ID属性
		listClass:"kimComboBoxList",//下拉框的class属性
		listWidth:"100%",//下拉框的宽度
		listHeight:"200px",//下拉框的高度
		listBackground:"#fff",//下拉框的背景色
		listBorder:"1px solid #bfcbd9",//下拉框的边框
		showSearch:true,//是否显示搜索框
		searchBoxWidth:"200px",//搜索框的宽度
		searchedColor: "red",//搜索匹配到的数据颜色
		noDataText: "无匹配数据",//搜索不到数据时的提示信息
		listType:"list",//下拉框的类型
		useFindIdByText: false,//根据文本找对应的ID
		useFindTextById: false,//根据ID找对应的文本
		useFindTextByIds: false,//根据多选的ID找到对应的多文本
		showClearButton: true,//是否显示重置按钮
		listids:["1111","2222","3333"],//下拉框里的值对应的id
		listcontents:["list下拉框测试1","list下拉框测试2","list下拉框测试3"],//下拉框里的值（针对下拉框为list类型的值）
		isMultiSelect:false,//是否支持多选
		triggerClick:true,//下拉框里的数据是否可选择
		disable: false,//下拉框是否禁止点击
		onchange:function(obj,ids,values){},//值变化事件
		tree:{}//下拉框为树类型的树初始化
	};

	//显示重置按钮
	function showClear(opts,$this){
		var val = $this.find(".contents").text().trim();
		if(isNotEmpty(val) && val !== opts.textValue && $this.find(".kimComboBox").find(".icon .fa").hasClass("fa-sort-down")){
			$this.find(".contents").parent().find(".icon .fa").removeClass("fa-sort-down").addClass("fa-remove selectClear");
		}
	}
	
	//阻止事件冒泡
	function stopPropagation(e) {
		// 如果提供了事件对象，则这是一个非IE浏览器
		if (e && e.stopPropagation){
			// 因此它支持W3C的stopPropagation()方法
			e.stopPropagation();
		}else{
			// 否则，我们需要使用IE的方式来取消事件冒泡
			window.event.cancelBubble = true;
		}
	};

	//阻止浏览器的默认行为 
	function stopDefault(e) { 
		//阻止默认浏览器动作(W3C) 
		if ( e && e.preventDefault ){ 
			e.preventDefault(); 
		//IE中阻止函数器默认动作的方式 
		}else{
			window.event.returnValue = false; 
		}
		return false; 
	}

	// 判断空
	function isEmpty(val) {
		val = $.trim(val);
		if (val == null )
			return true;
		if (val == undefined || val == 'undefined')
			return true;
		if (val == "")
			return true;
		if (val.length == 0)
			return true;
		if (!/[^(^\s*)|(\s*$)]/.test(val))
			return true;
		return false;
	}

	//判断非空
	function isNotEmpty(val) {
		return !isEmpty(val);
	}

})(jQuery);